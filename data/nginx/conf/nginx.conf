load_module /usr/lib/nginx/modules/ngx_http_image_filter_module.so;
user  root;
worker_processes  1;

#error_log  logs/error.log;
error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';
  
    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;
    
    #upstream fdfs_group1 {
    #     server 192.168.1.74:8888 weight=1 max_fails=2 fail_timeout=30s;
    #}

    server {
        listen 8088;
        server_name  localhost;

        location /image-resize {
            alias /var/local/fdfs/storage/data;
            image_filter resize $arg_width $arg_height;
            allow 127.0.0.1;
            deny all;
        }

        location /crop {
            alias /var/local/fdfs/storage/data;
            image_filter resize $arg_width $arg_height;
            image_filter crop $arg_width $arg_height;
            allow 127.0.0.1;
            deny all;
        }
        location ~* group1/M00/(.+)/(.+)/(.+)_(200|375|705|1242|)x(200|300|537|696|)\.(jpg|png|jpeg|gif)$ {
            alias /var/local/fdfs/storage/data;
            if (-f $request_filename) {
                return 406;
            }
            set $filepath "$1/$2";
            set $filename "$3.$6";
            set $thumb    "$3_$4x$5.$6";
            set $width    $4;
            set $height   $5;

            if (!-f $document_root/$filepath/$filename) {
                return 404;
            }

            rewrite /(.*)\/([0-9a-fx_]+)\.(.*) /imgcache/$2.$3;
            if ( $height = "" ){
                proxy_pass http://127.0.0.1:$server_port/image-resize/$filepath/$filename?width=$width&height=$width;
                break;
            }
            if ( $width = "" ){
                proxy_pass http://127.0.0.1:$server_port/image-resize/$filepath/$filename?width=$height&height=$height;
                break;
            }
            if (!-f $request_filename) {
                proxy_pass http://127.0.0.1:$server_port/crop/$filepath/$filename?width=$width&height=$height;
                break;
            }

            proxy_store          $document_root/imgcache/$thumb;
            proxy_store_access   user:rw  group:rw  all:r;
            proxy_set_header     Host $host;
        }
        location  /group1/M00 {
                alias /var/local/fdfs/storage/data;
                ngx_fastdfs_module;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            #root   html;
        }
    }

}
